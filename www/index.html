<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kohlenhydrat-Quiz ‚Äì Essen & Insulin</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#16a34a">

  <!-- iOS ‚ÄúAdd to Home Screen‚Äù -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Diabetes-Quiz">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">


  <style>
    :root{
      --bg:#f8fafc; --ink:#0f172a; --muted:#64748b;
      --brand:#16a34a; --ok:#dcfce7; --error:#fee2e2; --accent:#fde68a;
      --card:#ffffff; --shadow:0 8px 26px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans","DejaVu Sans",sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,#eafff3,#f8fafc);border-bottom:1px solid #d1fae5;padding:12px 14px;z-index:10}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0;font-size:clamp(20px,3.2vw,30px);color:#065f46;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sub{color:var(--muted);margin-top:2px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-top:10px}
    .pill{background:#e6f2ff;border:1px solid #cfe6ff;color:#0b4a8b;padding:6px 10px;border-radius:999px;font-weight:900;display:inline-flex;align-items:center;gap:6px}
    label{font-weight:900;font-size:13px;color:#0f172a}
    select,input[type="number"],input[type="text"],button{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:var(--card)}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;transition:all .2s ease}
    .btn.green{background:#16a34a;color:#fff}
    .btn.secondary{background:#e2e8f0;color:#1f2937;border:1px solid #cbd5e1}
    .btn.ghost{background:#f1f5f9;border:1px solid #94a3b8;color:#1e293b}
    .btn.ghost:hover{background:#e2e8f0;border-color:#64748b;color:#0f172a}
    main{padding:14px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .score{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .score .box{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:6px 10px;font-weight:900}
    .prog{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    #bar{height:100%;width:0;background:linear-gradient(90deg,#34d399,#10b981)}
    .food{display:flex;gap:12px;align-items:center}
    .food .emoji{font-size:48px;line-height:1;border-radius:14px;background:#fffbe8;padding:6px 10px}
    .food .name{font-size:22px;font-weight:900}
    .food .meta{color:var(--muted);font-weight:700;margin-top:2px}
    .q{font-size:18px;font-weight:900;margin:6px 0 4px}
    .options{display:grid;gap:10px;margin-top:12px}
    .opt{display:flex;align-items:center;gap:10px;border:2px solid #e5e7eb;background:#f9fafb;border-radius:12px;padding:12px;font-weight:900;cursor:pointer}
    .opt:hover{border-color:#cbd5e1}
    .opt.correct{border-color:#16a34a;background:#f0fdf4}
    .opt.wrong{border-color:#ef4444;background:#fff1f2}
    .explain{margin-top:10px;padding:10px;border-radius:12px;border:2px solid #e5e7eb;background:#ffffff}
    .explain.ok{border-color:#86efac;background:#f0fdf4}
    .explain.err{border-color:#fecaca;background:#fff1f2}
    .footer{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left}
    th{background:#f8fafc}

    .compact-fields{gap:8px}
    .compact-fields label{margin-bottom:2px;line-height:1.05}
    .compact-fields input,.compact-fields select,.compact-fields button{padding:9px 10px}

    .poolbar{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}
    .poolbar select{flex:1 1 auto;min-width:0}
    .poolbar button{white-space:nowrap}

    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    @media (max-width:720px){
      header{position:static}
      main{padding:10px}
      .card{padding:14px}
      .food .emoji{font-size:44px}
      .footer{flex-direction:column}
      .footer button{width:100%}
      .poolbar{gap:8px;flex-wrap:wrap}
      .pill{font-size:12.5px;padding:5px 8px}
    }

    /* Branding */
    .brandbar{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
    .brand-left{display:flex;gap:12px;align-items:flex-start;min-width:min(560px,100%)}
    .brand-logo{width:120px;height:auto;flex:0 0 auto;filter:drop-shadow(0 2px 4px rgba(2,6,23,.08))}
    .brand-text{line-height:1.2}
    .brand-name{font-weight:900;color:#064e3b;white-space:nowrap}
    .brand-role{color:var(--muted);font-weight:800}
    .brand-org{color:#065f46;font-weight:900}
    .brand-meta{color:var(--muted);font-weight:700}

    /* Mobile Info Toggle */
    .brand-toggle{
      border:none;background:#e6f2ff;border:1px solid #cfe6ff;color:#0b4a8b;
      border-radius:999px;padding:4px 8px;font-weight:900;cursor:pointer;line-height:1;
    }
    @media (max-width:720px){
      .brand-text .brand-role,.brand-text .brand-org,.brand-text .brand-meta{display:none}
      .brand-extra{display:none}
      .brandbar.show-extra .brand-extra{display:block}
      .brandbar.show-extra .brand-role,
      .brandbar.show-extra .brand-org,
      .brandbar.show-extra .brand-meta{display:block !important}
    }

    /* Debug pill */
    #debugPill{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;font-weight:900}
    .debugOnly{display:none}
    body.show-debug .debugOnly{display:inline-flex}

    /* Debug card (rechte Spalte) ein/aus */
    .hidden{display:none !important}
  </style>
</head>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(console.warn);
    });
  }
</script>


<body>
<header>
  <div class="wrap">
    <div class="brandbar" aria-label="Absender">
       <!--<div class="brand-left">
        <img class="brand-logo" src="logo-reutlingen.png" alt="Kreiskliniken Reutlingen ‚Äì Logo">
        <div class="brand-text">
          <div class="row" style="gap:6px;align-items:center">
            <div class="brand-name">Dr. med. Tina Muckenhaupt</div>
            <button class="brand-toggle" id="brandToggle" aria-label="Info einblenden">‚ÑπÔ∏è</button>
          </div>
          <div class="brand-extra">
            <div class="brand-role">Fach√§rztin ¬∑ Leitung Diabeteszentrum</div>
            <div class="brand-org">Kreiskliniken Reutlingen</div>
            <div class="brand-meta">Funktionsober√§rztin f√ºr Kinder- und Jugendmedizin ¬∑ DDG Diabetologin</div>
          </div>
        </div>
      </div>
    </div> -->

    <h1>üçé Kohlenhydrat-Quiz ‚Äì Essen &amp; Insulin <span class="pill" id="unitPill">Anzeige: KE (10 g)</span></h1>
    <div class="sub">Zwei Fragen pro Lebensmittel ‚Äì <b>Wie viele Kohlenhydrate?</b> und <b>Wie viel Insulin?</b> ‚Ä¢ (Lernspiel, keine medizinische Anordnung)</div>

    <div class="toolbar">

      <div class="row compact-fields">
        <div>
          <label for="factor">Insulin-Faktor</label><br>
          <input type="number" id="factor" value="10" min="5" max="50" step="0.5">
        </div>
        <div>
          <label>&nbsp;</label><br>
          <button class="btn secondary" id="setKE" title="1 IE deckt 10 g KH">KE (10 g)</button>
        </div>
        <div>
          <label>&nbsp;</label><br>
          <button class="btn secondary" id="setBE" title="1 IE deckt 12 g KH">BE (12 g)</button>
        </div>
        <div class="muted" style="padding-bottom:6px">‚Üí 1 IE deckt <b id="factorView">10</b> g KH</div>
      </div>

      <div class="row compact-fields">
        <div>
          <label for="unitSel">KH-Anzeige</label><br>
          <select id="unitSel">
            <option value="KE" selected>KE (10 g)</option>
            <option value="BE">BE (12 g)</option>
            <option value="G">Gramm (g)</option>
          </select>
        </div>
        <div>
          <label for="rounding">Rundung Insulin</label><br>
          <select id="rounding">
            <option value="0.5" selected>auf 0,5 IE</option>
            <option value="0.1">auf 0,1 IE</option>
            <option value="1">auf 1,0 IE</option>
          </select>
        </div>
        <div>
          <label for="mode">Schwierigkeit</label><br>
          <select id="mode">
            <option value="normal" selected>Normal</option>
            <option value="leicht">Leicht</option>
            <option value="schwer">Schwer</option>
          </select>
        </div>
        <div>
          <label for="levelSel">Level</label><br>
          <select id="levelSel" style="min-width:260px">
            <option value="kids_basic" selected>Kids ‚Äì Leicht</option>
            <option value="kids_sweets">Kids ‚Äì Snacks &amp; S√º√ües</option>
            <option value="all">Alle Kategorien</option>
          </select>
        </div>
      </div>

      <div class="row compact-fields">
        <div>
          <label for="tolCarb">Toleranz KH</label><br>
          <input type="number" id="tolCarb" value="1" min="0" step="0.5" style="width:90px">
        </div>
        <div>
          <label for="tolCarbUnit">&nbsp;</label><br>
          <select id="tolCarbUnit">
            <option value="unit" selected>in KE/BE</option>
            <option value="g">in g</option>
          </select>
        </div>
        <div>
          <label for="tolIns">Toleranz Insulin (IE)</label><br>
          <input type="number" id="tolIns" value="0.1" min="0" step="0.1" style="width:110px">
        </div>
        <div>
          <label for="fixMode">Korrekturen</label><br>
          <select id="fixMode">
            <option value="off" selected>Aus</option>
            <option value="on">An (als Paar)</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label><br>
          <button class="btn green" id="restartBtn">Neu starten</button>
        </div>

        

        <div>
          <label>&nbsp;</label><br>
          <button class="btn ghost" id="debugToggleBtn" title="Debug/Daten ein/aus">Debug/Daten</button>
        </div>
      </div>

      <div class="row poolbar" style="width:min(760px,100%)">
        <div style="flex:0 0 auto">
          <label for="remotePoolSelect" style="display:block">Quiz</label>
        </div>
        <select id="remotePoolSelect" aria-label="Quiz ausw√§hlen">
          <option value="ke_fragepool.csv">Standard</option>
          <option value="ke_fragepool_schule_freizeit.csv">Schule/Freizeit</option>
        </select>
        <button class="btn ghost" id="loadRemotePoolBtn">Quiz laden ‚¨áÔ∏è</button>
        <span id="remotePoolStatus" class="pill">‚Äî</span>
        <span id="debugPill" class="pill debugOnly" title="Debug: zeigt, ob App-CSV injiziert wurde">Debug: ‚Ä¶</span>
      </div>

    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="score">
          <div class="box">‚úÖ Richtig: <span id="okCount">0</span></div>
          <div class="box">‚ùå Falsch: <span id="badCount">0</span></div>
          <div class="box">üî• Serie: <span id="streak">0</span></div>
          <div class="box">ü©π Korrekturen: <span id="fixCount">0</span></div>
        </div>
        <div class="prog" style="margin-top:10px"><div id="bar"></div></div>

        <div id="food" style="margin-top:12px"></div>
        <div class="q" id="question">Quiz laden‚Ä¶</div>
        <div class="muted" id="hint"></div>

        <div class="options" id="options"></div>

        <div class="explain" id="explain" style="display:none"></div>

        <div class="footer">
          <button class="btn secondary" id="skipBtn">√úberspringen</button>
          <button class="btn secondary" id="nextBtn" disabled>Weiter</button>
        </div>
      </section>

      <aside class="card" id="debugCard">
        <h3 style="margin-top:0">Daten (Debug)</h3>
        <p class="muted">Diese Tabelle dient nur zum Pr√ºfen der CSV. Per <b>Debug/Daten</b> ein-/ausblendbar.</p>
        <div style="overflow:auto;max-height:520px">
          <table>
            <thead>
              <tr>
                <th>cat</th><th>name</th><th>portion</th><th>carbs (g)</th>
              </tr>
            </thead>
            <tbody id="debugTableBody"></tbody>
          </table>
        </div>
      </aside>
    </div>
  </div>
</main>

<script>
/* =========================
   Utilities / DOM helpers
========================= */
function $(id){ return document.getElementById(id); }
function toNum(x){ const n = parseFloat(x); return Number.isFinite(n) ? n : 0; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function fmt(x){
  if(!Number.isFinite(x)) return String(x);
  const s = (Math.round(x*100)/100).toString();
  return s.replace('.', ',');
}
function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, m=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function roundTo(value, step){
  if(step<=0) return value;
  return Math.round(value/step)*step;
}
function nearly(a,b,tol){
  return Math.abs(a-b) <= tol;
}
function extractNumberFromLabel(text){
  const m = String(text).match(/-?\d+(?:[.,]\d+)?/);
  if(!m) return NaN;
  return parseFloat(m[0].replace(',','.'));
}

/* =========================
   Storage / Bank
========================= */
const STORAGE_BANK = 'khquiz_bank_v3';
const STORAGE_POOL = 'khquiz_pool_v3';
let BANK = [];

function saveBank(bank){
  try{ localStorage.setItem(STORAGE_BANK, JSON.stringify(bank)); }catch(e){}
}
function loadBank(){
  try{
    const s = localStorage.getItem(STORAGE_BANK);
    if(!s) return [];
    const a = JSON.parse(s);
    return Array.isArray(a) ? a : [];
  }catch(e){ return []; }
}

/* =========================
   CSV parsing
========================= */
function parseCSVFlexible(text){
  const lines = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim().length);
  if(!lines.length) return [];
  const rows = [];
  for(const line of lines){
    const out = [];
    let cur = '', q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(q && line[i+1] === '"'){ cur += '"'; i++; }
        else q = !q;
      }else if(ch === ',' && !q){
        out.push(cur);
        cur='';
      }else cur += ch;
    }
    out.push(cur);
    rows.push(out.map(s=>s.trim()));
  }
  return rows;
}

function mapRowsToBank(rows){
  if(!rows.length) return [];
  const header = rows[0].map(h=>h.toLowerCase());
  const col = (name)=> header.indexOf(name);
  const iCat = col('cat');
  const iName = col('name');
  const iEmoji = col('emoji');
  const iPortion = col('portion');
  const iCarbs = col('carbs');
  const iInfo = col('info');

  const out = [];
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    const name = row[iName] ?? '';
    const carbs = toNum(String(row[iCarbs] ?? '').replace(',','.'));
    if(!name || !Number.isFinite(carbs)) continue;
    out.push({
      cat: row[iCat] ?? '',
      name,
      emoji: row[iEmoji] ?? 'üçΩÔ∏è',
      portion: row[iPortion] ?? '',
      carbs,
      info: row[iInfo] ?? ''
    });
  }
  return out;
}

/* =========================
   Loading pool: App injection first, else fetch
========================= */
async function loadRepoPool(url){
  const statusEl = $('remotePoolStatus');
  const setStatus = (t)=>{ if(statusEl) statusEl.textContent=t; };
  setStatus('Lade‚Ä¶');

  if (window.ANDROID_CSVS && typeof window.ANDROID_CSVS[url] === "string" && window.ANDROID_CSVS[url].trim()) {
    const text = window.ANDROID_CSVS[url];
    const rows = parseCSVFlexible(text);
    const bank = mapRowsToBank(rows);
    if(!bank.length) throw new Error("Injected CSV ohne Daten");
    BANK = bank; saveBank(BANK);
    setStatus('‚úÖ geladen (App): '+url+' ('+BANK.length+')');
    return true;
  }

  if (location.protocol === 'file:') {
    setStatus('‚ö†Ô∏è Lokal ge√∂ffnet (file://) ‚Äì bitte √ºber APK oder http://127.0.0.1 starten');
    console.warn('file:// erkannt: fetch() auf CSV ist im Browser oft blockiert.');
    return false;
  }

  try{
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const rows = parseCSVFlexible(text);
    const bank = mapRowsToBank(rows);
    if(!bank.length) throw new Error('CSV ohne g√ºltige Daten');
    BANK = bank; saveBank(BANK);
    setStatus('‚úÖ geladen (Web): '+url+' ('+BANK.length+')');
    return true;
  }catch(err){
    console.warn('Pool laden fehlgeschlagen:', err);
    setStatus('‚ö†Ô∏è Quiz konnte nicht geladen werden');
    return false;
  }
}

function wirePoolUI(){
  const sel = $('remotePoolSelect');
  const btn = $('loadRemotePoolBtn');
  const saved = localStorage.getItem(STORAGE_POOL);
  if(saved) sel.value = saved;

  if (location.protocol === 'file:') $('remotePoolStatus').textContent = '‚ÑπÔ∏è Lokal ge√∂ffnet ‚Äì CSV bitte √ºber APK/localhost laden';
  else $('remotePoolStatus').textContent = 'Bereit: ' + sel.value;

  sel.addEventListener('change', ()=>{
    localStorage.setItem(STORAGE_POOL, sel.value);
    $('remotePoolStatus').textContent = 'Bereit: ' + sel.value;
  });

  btn.addEventListener('click', async ()=>{
    const ok = await loadRepoPool(sel.value);
    if(ok) start();
  });
}

/* =========================
   Unit helpers
========================= */
function unitGram(){
  const u = $('unitSel').value;
  if(u === 'KE') return 10;
  if(u === 'BE') return 12;
  return 1;
}
function unitLabel(){
  const u = $('unitSel').value;
  if(u === 'KE') return 'KE';
  if(u === 'BE') return 'BE';
  return 'g';
}
function setUnitPill(){
  const u = $('unitSel').value;
  const pill = $('unitPill');
  if(u==='KE') pill.textContent = 'Anzeige: KE (10 g)';
  else if(u==='BE') pill.textContent = 'Anzeige: BE (12 g)';
  else pill.textContent = 'Anzeige: Gramm (g)';
}
function tolCarbInGrams(){
  const t = toNum($('tolCarb').value);
  if($('tolCarbUnit').value === 'g') return t;
  return t * unitGram();
}
function tolIns(){
  return Math.max(0, toNum($('tolIns').value));
}

/* =========================
   Options
========================= */
function buildOptions(correct, kind){
  const mode = $('mode').value;
  let step = 0.5;
  if(kind === 'ins') step = toNum($('rounding').value) || 0.5;
  else step = (unitLabel() === 'g') ? 1 : 0.5;

  const spread = (mode === 'leicht') ? 2 : (mode === 'schwer') ? 5 : 3;

  const values = new Set();
  const snap = (v)=> roundTo(v, step);

  values.add(snap(correct));

  for(let k=0; values.size < 4 && k < 60; k++){
    const delta = (Math.floor(Math.random()*(spread*2+1)) - spread) * step;
    let v = snap(correct + delta);
    if(v < 0) v = 0;
    values.add(v);
  }
  while(values.size < 4) values.add(snap(correct + values.size * step));

  const arr = Array.from(values).slice(0,4);
  return shuffle(arr);
}

function drawOptions(values, onPick){
  const u = (STATE.step === 'ins') ? 'IE' : unitLabel();
  const container = $('options');
  container.innerHTML = '';
  values.forEach(v=>{
    const btn = document.createElement('button');
    btn.className = 'opt';
    btn.type = 'button';
    btn.textContent = `${fmt(v)} ${u}`;
    btn.addEventListener('click', ()=> onPick(v));
    container.appendChild(btn);
  });
}

/* =========================
   Debug table
========================= */
function updateDebugTable(){
  const body = $('debugTableBody');
  if(!body) return;
  const view = (BANK || []).slice(0, 120);
  body.innerHTML = view.map(it=>`
    <tr>
      <td>${escapeHtml(it.cat)}</td>
      <td>${escapeHtml(it.name)}</td>
      <td>${escapeHtml(it.portion)}</td>
      <td>${fmt(it.carbs)}</td>
    </tr>
  `).join('');
}

/* =========================
   Progress
========================= */
function updateProgress(force01){
  const bar = $('bar');
  if(force01 === 1){ bar.style.width = '100%'; return; }
  const total = Math.max(1, STATE.order.length);
  const done = Math.min(total, STATE.idx);
  const p = clamp(done/total, 0, 1);
  bar.style.width = (p*100).toFixed(1)+'%';
}

/* =========================
   State + Fix Queue (als Paar)
========================= */
const STATE = {
  order: [],
  idx: 0,
  current: null,
  locked: false,

  // step = 'carb' (Frage 1/2) oder 'ins' (Frage 2/2)
  step: 'carb',

  // nachdem KH beantwortet wurde: true -> next() zeigt Insulin-Frage
  needInsQuestion: false,

  stats: {ok:0, bad:0, streak:0},
  fixQueue: [],
  fixDone: 0,
  inFix: false
};

function enqueueFixItem(item){
  const key = (x)=>`${x.name}||${x.portion}||${x.carbs}`;
  const k = key(item);
  if(STATE.fixQueue.some(it => key(it) === k)) return;
  STATE.fixQueue.push(item);
  $('fixCount').textContent = String(STATE.fixQueue.length);
}

/* =========================
   Level filter (placeholder)
========================= */
function filterBankByLevel(bank){
  // aktuell keine harte Filterlogik ‚Äì sp√§ter nach cat etc. m√∂glich
  return bank.slice();
}

/* =========================
   Render
========================= */
function render(){
  const it = STATE.current;
  if(!it) return;

  const portion = it.portion ? 'Portion: ' + it.portion : '';
  const cat = it.cat ? it.cat : '';
  $('food').innerHTML = `
    <div class="food">
      <div class="emoji">${escapeHtml(it.emoji || 'üçΩÔ∏è')}</div>
      <div>
        <div class="name">${escapeHtml(it.name)}</div>
        <div class="meta">${escapeHtml([cat, portion].filter(Boolean).join(' ¬∑ '))}</div>
      </div>
    </div>
  `;

  $('explain').style.display = 'none';
  $('explain').textContent = '';
  $('explain').className = 'explain';

  const u = unitLabel();
  const gPerUnit = unitGram();

  if(STATE.step === 'carb'){
    $('question').textContent = `Frage 1/2: Wie viele ${u} hat diese Portion?`;
    $('hint').textContent = (u==='g')
      ? `Antwort in Gramm (g).`
      : `Hinweis: 1 ${u} = ${gPerUnit} g Kohlenhydrate.`;

    const correct = (u==='g') ? it.carbs : it.carbs / gPerUnit;
    const opts = buildOptions(correct, 'carb');
    drawOptions(opts, (val)=>chooseCarb(val, correct));
  }else{
    $('question').textContent = `Frage 2/2: Wie viel Insulin (IE) braucht diese Portion?`;
    const factor = Math.max(1e-9, toNum($('factor').value) || 10);
    const step = toNum($('rounding').value) || 0.5;
    $('hint').textContent = `Rechnung: ${fmt(it.carbs)} g √∑ ${fmt(factor)} g/IE ‚Üí Rundung ${fmt(step)} IE`;

    const raw = it.carbs / factor;
    const correct = roundTo(raw, step);
    const opts = buildOptions(correct, 'ins');
    drawOptions(opts, (val)=>chooseIns(val, correct));
  }

  updateDebugTable();
}

/* =========================
   Flow: start / next / skip
========================= */
function start(){
  if(!BANK.length){
    $('question').textContent = 'Noch kein Quiz geladen.';
    $('hint').textContent = 'Bitte oben ein Quiz laden.';
    $('food').innerHTML = '';
    $('options').innerHTML = '';
    $('nextBtn').disabled = true;
    return;
  }

  const base = filterBankByLevel(BANK);
  STATE.order = shuffle(base.slice());
  STATE.idx = 0;
  STATE.current = null;
  STATE.locked = false;
  STATE.step = 'carb';
  STATE.needInsQuestion = false;

  STATE.stats = {ok:0, bad:0, streak:0};
  STATE.fixQueue = [];
  STATE.fixDone = 0;
  STATE.inFix = false;

  $('okCount').textContent = '0';
  $('badCount').textContent = '0';
  $('streak').textContent = '0';
  $('fixCount').textContent = '0';

  $('nextBtn').textContent = 'Weiter';
  $('nextBtn').disabled = true;

  setUnitPill();
  updateDebugTable();
  next();
}

function pickNextItem(){
  const fixOn = $('fixMode').value === 'on';

  if(fixOn && STATE.fixQueue.length && STATE.idx >= STATE.order.length){
    STATE.inFix = true;
    STATE.current = STATE.fixQueue.shift();
    $('fixCount').textContent = String(STATE.fixQueue.length);
    return true;
  }

  STATE.inFix = false;
  if(STATE.idx >= STATE.order.length) return false;
  STATE.current = STATE.order[STATE.idx];
  return true;
}

function next(){
  // Spezialfall: nach KH wurde Insulin f√§llig -> jetzt Insulin-Frage anzeigen
  if(STATE.needInsQuestion){
    STATE.needInsQuestion = false;
    STATE.locked = false;
    STATE.step = 'ins';
    $('options').innerHTML = '';
    $('nextBtn').disabled = true;
    $('nextBtn').textContent = 'Weiter';
    render();
    return;
  }

  // Wenn Insulin beantwortet war (oder wir normal weiter wollen): Item abschlie√üen
  if(STATE.current){
    // Item fertig -> Index weiter
    if(!STATE.inFix) STATE.idx++;
    else STATE.fixDone++;
  }

  STATE.locked = false;
  STATE.step = 'carb';
  STATE.needInsQuestion = false;
  $('nextBtn').disabled = true;
  $('nextBtn').textContent = 'Weiter';
  $('options').innerHTML = '';
  $('explain').style.display = 'none';

  const ok = pickNextItem();
  if(!ok){
    $('question').textContent = 'üéâ Fertig!';
    $('hint').textContent = 'Neu starten oder anderes Quiz laden.';
    $('food').innerHTML =
      '<div class="food"><div class="emoji">‚úÖ</div><div><div class="name">Super gemacht!</div>' +
      '<div class="meta">Richtig: '+STATE.stats.ok+' ¬∑ Falsch: '+STATE.stats.bad+' ¬∑ Korrekturen erledigt: '+STATE.fixDone+'</div></div></div>';
    $('options').innerHTML = '';
    updateProgress(1);
    return;
  }

  render();
  updateProgress();
}

function skip(){
  // √ºberspringt das komplette Paar
  STATE.needInsQuestion = false;
  next();
}

/* =========================
   Answer handling
========================= */
function disableOptionButtons(){
  const buttons = Array.from($('options').children);
  for(const b of buttons) b.disabled = true;
  return buttons;
}

function markPicked(buttons, picked, ok){
  const pickedBtn = buttons.find(b => {
    const v = extractNumberFromLabel(b.textContent);
    return Number.isFinite(v) && nearly(v, picked, 1e-9);
  });
  if(pickedBtn) pickedBtn.classList.add(ok ? 'correct' : 'wrong');
}

function showExplain(html, ok){
  const exp = $('explain');
  exp.style.display = 'block';
  exp.className = 'explain ' + (ok ? 'ok' : 'err');
  exp.innerHTML = html;
}

function updateStats(ok, itemForFix){
  if(ok){
    STATE.stats.ok++;
    STATE.stats.streak++;
  }else{
    STATE.stats.bad++;
    STATE.stats.streak = 0;
    if($('fixMode').value === 'on' && itemForFix){
      enqueueFixItem(itemForFix);
    }
  }
  $('okCount').textContent = String(STATE.stats.ok);
  $('badCount').textContent = String(STATE.stats.bad);
  $('streak').textContent = String(STATE.stats.streak);
}

function chooseCarb(picked, correctDisplay){
  if(STATE.locked) return;
  STATE.locked = true;

  const it = STATE.current;
  const u = unitLabel();

  const pickedG  = (u==='g') ? picked : picked * unitGram();
  const correctG = it.carbs;
  const ok = nearly(pickedG, correctG, tolCarbInGrams());

  const buttons = disableOptionButtons();
  markPicked(buttons, picked, ok);

  updateStats(ok, it);

  const displayCorrect = (u==='g') ? it.carbs : (it.carbs / unitGram());
  const tolTxt = ($('tolCarbUnit').value === 'g')
    ? `${fmt(toNum($('tolCarb').value)||0)} g`
    : `${fmt(toNum($('tolCarb').value)||0)} ${u}`;

  showExplain(`
    <div style="font-weight:900">${ok ? '‚úÖ Richtig!' : '‚ùå Nicht ganz.'}</div>
    <div>Korrekt: <b>${fmt(roundTo(displayCorrect, u==='g'?1:0.5))} ${u}</b> (=${fmt(it.carbs)} g KH)</div>
    <div class="muted">Toleranz: ${tolTxt}</div>
    ${it.info ? `<div style="margin-top:8px">${escapeHtml(it.info)}</div>` : ''}
  `, ok);

  // Jetzt kommt Insulin als Schritt 2/2 ‚Äì aber erst per Next-Button
  STATE.needInsQuestion = true;
  $('nextBtn').textContent = 'Insulin-Frage ‚Üí';
  $('nextBtn').disabled = false;
}

function chooseIns(picked, correct){
  if(STATE.locked) return;
  STATE.locked = true;

  const it = STATE.current;
  const ok = nearly(picked, correct, tolIns());

  const buttons = disableOptionButtons();
  markPicked(buttons, picked, ok);

  updateStats(ok, it);

  const factor = toNum($('factor').value) || 10;
  const raw = it.carbs / factor;
  const step = toNum($('rounding').value) || 0.5;

  showExplain(`
    <div style="font-weight:900">${ok ? '‚úÖ Richtig!' : '‚ùå Nicht ganz.'}</div>
    <div>Rechnung: ${fmt(it.carbs)} g √∑ ${fmt(factor)} g/IE = ${fmt(raw)} IE ‚Üí gerundet: <b>${fmt(correct)} IE</b></div>
    <div class="muted">Rundung: ${fmt(step)} IE ¬∑ Toleranz: ${fmt(tolIns())} IE</div>
  `, ok);

  $('nextBtn').textContent = 'Weiter';
  $('nextBtn').disabled = false;
}

/* =========================
   UI Events
========================= */
$('factor').addEventListener('input', e=>{
  const v = clamp(parseFloat(e.target.value)||10, 5, 50);
  $('factor').value = v; $('factorView').textContent = fmt(v);
});

$('setKE').onclick = ()=>{
  $('factor').value = 10;
  $('factor').dispatchEvent(new Event('input'));
  $('unitSel').value='KE';
  setUnitPill();
  start();
};

$('setBE').onclick = ()=>{
  $('factor').value = 12;
  $('factor').dispatchEvent(new Event('input'));
  $('unitSel').value='BE';
  setUnitPill();
  start();
};

$('unitSel').addEventListener('change', ()=>{ setUnitPill(); start(); });
$('rounding').addEventListener('change', ()=> start());
$('mode').addEventListener('change', ()=> start());
$('levelSel').addEventListener('change', ()=> start());
$('tolCarb').addEventListener('change', ()=> start());
$('tolCarbUnit').addEventListener('change', ()=> start());
$('tolIns').addEventListener('change', ()=> start());
$('fixMode').addEventListener('change', ()=> start());

$('restartBtn').addEventListener('click', start);
$('nextBtn').addEventListener('click', next);
$('skipBtn').addEventListener('click', skip);

window.addEventListener('keydown', (e)=>{
  if(['1','2','3','4'].includes(e.key)){
    const i = parseInt(e.key,10)-1;
    const btn = $('options').children[i];
    if(btn && !btn.disabled) btn.click();
  }else if(e.key.toLowerCase()==='n'){
    if(!$('nextBtn').disabled) $('nextBtn').click();
  }
});



/* Debug/Daten Toggle: nur rechte Karte + Debug-Pill */
let debugVisible = true;
$('debugToggleBtn').addEventListener('click', ()=>{
  debugVisible = !debugVisible;
  $('debugCard').classList.toggle('hidden', !debugVisible);

  // Pill optional mit toggeln:
  document.body.classList.toggle('show-debug', debugVisible);
});

/* Branding toggle */
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('brandToggle');
  if(!btn) return;
  const bar = btn.closest('.brandbar');
  const setState = ()=>{
    const open = bar && bar.classList.contains('show-extra');
    btn.textContent = open ? '‚úï' : '‚ÑπÔ∏è';
    btn.setAttribute('aria-label', open ? 'Info ausblenden' : 'Info einblenden');
  };
  btn.addEventListener('click', function(e){
    e.preventDefault();
    if(!bar) return;
    bar.classList.toggle('show-extra');
    setState();
  });
  setState();
});

/* =========================
   Boot
========================= */
async function boot(){
  wirePoolUI();
  $('factor').dispatchEvent(new Event('input'));
  setUnitPill();

  // Debug default: AN (rechte Karte sichtbar), Pill sichtbar
  debugVisible = true;
  $('debugCard').classList.remove('hidden');
  document.body.classList.add('show-debug');

  const cached = loadBank();
  if(cached.length){
    BANK = cached;
    $('remotePoolStatus').textContent = '‚úÖ aus Cache geladen ('+BANK.length+')';
    updateDebugTable();
  }

  const sel = $('remotePoolSelect');
  const url = localStorage.getItem(STORAGE_POOL) || (sel ? sel.value : 'ke_fragepool.csv');
  if(sel) sel.value = url;

  function updateDebugPill(){
    const keys = window.ANDROID_CSVS ? Object.keys(window.ANDROID_CSVS) : [];
    const hasApp = keys.length > 0;
    const src = hasApp ? 'APK (injected)' : 'Web (fetch/cache)';
    $('debugPill').textContent = 'Debug: ' + src + ' ¬∑ Pools: ' + keys.length;
  }
  updateDebugPill();
  setInterval(updateDebugPill, 1000);

  await loadRepoPool(url);
  start();

  setTimeout(async ()=>{
    await loadRepoPool(sel.value);
    start();
  }, 1200);
}

boot();
</script>
</body>
</html>

